name: Create google.VertexModel from GoogleCloudVertexAiModelName
metadata:
  annotations:
    author: Alexey Volkov <alexey.volkov@ark-kun.com>
    canonical_location: 'https://raw.githubusercontent.com/Ark-kun/pipeline_components/KFPv2_hell/components/google-cloud/Vertex_AI/Models/Create_google.VertexModel/from_GoogleCloudVertexAiModelName/component.yaml'
inputs:
- {name: model_name, type: GoogleCloudVertexAiModelName}
outputs:
- {name: model, type: google.VertexModel}
implementation:
  container:
    image: python:3.10
    command:
    - sh
    - -ec
    - |
      program_path=$(mktemp)
      printf "%s" "$0" > "$program_path"
      python3 -u "$program_path" "$@"
    - |
      import json
      import sys
      from pathlib import Path

      model_name_path = sys.argv[1]
      executor_input = json.loads(sys.argv[2])

      model_name = Path(model_name_path).read_text()
      _, project, _, location, _, model_id = model_name.split("/")

      # Setting the resource name in the artifact metadata
      model_artifact = executor_input["outputs"]["artifacts"]["model"]["artifacts"][0]
      model_artifact["metadata"]["resourceName"] = model_name
      # Changing the artifact URI does not seem to be required...
      model_artifact["uri"] = f"https://{location}-aiplatform.googleapis.com/v1/{model_name}"
      executor_output = {"artifacts": executor_input["outputs"]["artifacts"]}
      executor_output_path = executor_input["outputs"]["outputFile"]
      Path(executor_output_path).parent.mkdir(parents=True, exist_ok=True)
      Path(executor_output_path).write_text(json.dumps(executor_output))
    # We have to consume the model_name as a file since KFPv2 compiler forbids consuming non-primitive types as values.
    - {inputPath: model_name}
    - {executorInput: null}
